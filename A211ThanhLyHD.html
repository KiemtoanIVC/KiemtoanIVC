<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>A211 - BIÊN BẢN NGHIỆM THU THANH LÝ HỢP ĐỒNG</title>
    <!-- Thêm vào sau các style hiện có -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!-- Summernote -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .export-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 24px;
            background-color: #22c55e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .export-button:hover {
            background-color: #16a34a;
        }

        .print-button {
            position: fixed;
            top: 20px;
            right: 160px;
            padding: 10px 24px;
            background-color: #14b8a6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .print-button:hover {
            background-color: #0d9488;
        }

        @media print {

            /* Ẩn tất cả các button */
            .print-button,
            .export-button,
            .edit-button,
            .save-button,
            .info-button {
                display: none !important;
            }

            /* Reset style cho các trường data-field khi in */
            [data-field] {
                background-color: transparent !important;
                border: none !important;
                padding: 0 !important;
                border-radius: 0 !important;
            }

            /* Ẩn tooltip khi in */
            [data-field]:hover::after {
                display: none !important;
            }
        }

        /* Thêm vào phần <style> */
        [data-field] {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px dashed #ffc107;
            position: relative;
            cursor: pointer;
        }

        [data-field]:hover {
            background-color: #ffeaa7;
            border-color: #fdcb6e;
        }

        [data-field]:hover::after {
            content: "Có thể chỉnh sửa";
            position: absolute;
            background: #2d3436;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            top: -30px;
            left: 0;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        .save-button {
            position: fixed !important;
            top: 20px !important;
            right: 400px !important;
            z-index: 9999 !important;
            padding: 10px 24px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .edit-button {
            position: fixed;
            top: 20px;
            right: 275px;
            padding: 10px 24px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body
    style="font-family: 'Times New Roman', serif; max-width: 800px; margin: 0 auto; padding: 20px 25px; line-height: 1.4; font-size: 13pt;">
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>
    <div id="fui-toast"></div>

    <button onclick="editContent()" class="action-button edit-button">Chỉnh sửa</button>
    <button onclick="saveContent()" class="action-button save-button" style="display: none;">Lưu lại</button>
    <button onclick="printDocument()" class="action-button print-button">In nhanh</button>
    <button onclick="exportToWord()" class="export-button">Xuất ra Word</button>
    <div id="Conten">
        <!-- Title -->
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td colspan="2">
                    <p style="text-align: center; margin-bottom: 5px; font-weight: bold;">CỘNG HOÀ XÃ HỘI CHỦ NGHĨA VIỆT
                        NAM</p>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <p style="text-align: center; margin-bottom: 5px; font-weight: bold;">Độc lập - Tự do - Hạnh phúc
                    </p>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <p style="text-align: center; margin-bottom: 5px;">------o0o------</p>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: right;">
                    <p style="margin: 0;"><i>Hà Nội, <span data-field="NgayThanhLy"></span></i></p>
                </td>
            </tr>
        </table>

        <div style="text-align: center; margin: 20px 0;">
            <p style="margin: 5px 0; font-weight: bold;">BIÊN BẢN NGHIỆM THU THANH LÝ HỢP ĐỒNG</p>
            <i style="margin: 10px 0;">Số: <span data-field="SoThanhLy"></span></i>
        </div>

        <!-- Legal basis -->
        <div style="margin-top: 20px; line-height: 1.8;">
            <span><i>● Căn cứ Bộ luật dân sự số 91/2015/QH13 ngày 24/11/2015;</i></span><br>
            <span><i>● Căn cứ Luật thương mại số 36/2005/QH11 ngày 14/6/2005;</i></span><br>
            <span style="margin: 0; line-height: 1.5;"><i>● Căn cứ Hợp đồng kiểm toán Số: <span
                        data-field="SoHopDong"></span> <span data-field="NgayHopDong"></span> giữa Bên A: <span
                        data-field="TenKH"></span> và Bên B: Công ty TNHH Kiểm toán IVC về việc <span
                        data-field="NoiDungHopDong"></span> của <span data-field="TenKH2"></span>.</i></span>
        </div>
        <p style="margin: 20px 20px 0;">Biên bản này được lập vào <span data-field="NgayThanhLy2"></span>,
            giữa:</p>

        <!-- Party A -->
        <div style="margin-top: 20px;">
            <p style="margin: 0; font-weight: bold;">BÊN A : <span data-field="TenKH3"></span></p>
            <table style="margin-left: 40px; border-collapse: collapse;">
                <tr>
                    <td style="width: 120px; padding: 5px 0; font-weight: bold;">Người đại diện</td>
                    <td style="padding: 5px 0; font-weight: bold;"> : <span data-field="NguoiDaiDienKH"></span></td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Chức vụ</td>
                    <td style="padding: 5px 0;"> : <span data-field="ChucVuKH"></span></td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Địa chỉ</td>
                    <td style="padding: 5px 0;"> : <span data-field="DiaChiKH"></span></td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Mã số thuế</td>
                    <td style="padding: 5px 0;"> : <span data-field="MST_KH"></span></td>
                </tr>
            </table>
        </div>

        <!-- Party B -->
        <div style="margin-top: 20px;">
            <p style="margin: 0; font-weight: bold; ">BÊN B: CÔNG TY TNHH KIỂM TOÁN IVC</p>
            <table style="margin-left: 40px; border-collapse: collapse;">
                <tr>
                    <td style="width: 120px; padding: 5px 0; font-weight: bold;">Người đại diện</td>
                    <td style="padding: 5px 0; font-weight: bold;"> : Ông Phạm Duy Hiệp</td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Chức vụ</td>
                    <td style="padding: 5px 0;"> : Phó Tổng Giám đốc</td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Địa chỉ</td>
                    <td style="padding: 5px 0;"> : Tầng 2, số 1 ngõ 2 Láng Hạ, phường Thành Công, quận Ba Đình, thành
                        phố Hà
                        Nội</td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Điện thoại</td>
                    <td style="padding: 5px 0;"> : 0943 863 073</td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Mã số thuế</td>
                    <td style="padding: 5px 0;"> : 0109564702</td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Tài khoản số</td>
                    <td style="padding: 5px 0;"> : 0909597168888</td>
                </tr>
                <tr>
                    <td style="width: 120px; padding: 5px 0;">Tại Ngân hàng</td>
                    <td style="padding: 5px 0;"> : Ngân hàng TMCP Quân Đội - CN Hoài Đức</td>
                </tr>
            </table>
        </div>
        <p style="margin: 20px 0;">Cùng nhau tiến hành thanh lý Hợp đồng kiểm toán số: <span
                data-field="SoHopDong2"></span>
            <span data-field="NgayHopDong2"></span> với các nội dung sau:
        </p>

        <!-- Contract Implementation -->
        <div style="margin-top: 20px;">
            <p style="margin: 10px 0; font-weight: bold;">I - TÌNH HÌNH THỰC HIỆN HỢP ĐỒNG</p>
            <p style="margin: 10px 0; text-align: justify;">
                Hai bên đã thực hiện đúng các điều khoản cam kết của Hợp đồng, Bên B đã bàn giao các Báo cáo kiểm toán
                về
                Báo cáo tài chính cho Bên A.
            </p>

            <p style="margin: 20px 0 10px; font-weight: bold;">II - THANH TOÁN</p>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="width: 10%; text-align: center; border-bottom: 1px solid black; padding: 5px;">STT</th>
                    <th style="width: 55%; text-align: left; border-bottom: 1px solid black; padding: 5px;">Nội dung
                    </th>
                    <th style="width: 3%; text-align: right; padding: 5px;"></th>
                    <th style="width: 32%; text-align: left; border-bottom: 1px solid black; padding: 5px;">Số tiền
                        (VND)
                    </th>
                </tr>
                <tr>
                    <td style="text-align: center;  padding: 5px;">1.</td>
                    <td style=" padding: 5px;">Giá trị hợp đồng đã ký</td>
                    <td style="text-align: right; padding: 5px;"></td>
                    <td style="text-align: left; padding: 5px;"><span data-field="GiaTriHopDongChuaVAT"></span></td>
                </tr>
                <tr>
                    <td style="text-align: center; padding: 5px;">2.</td>
                    <td style="padding: 5px;">VAT</td>
                    <td style="text-align: right; padding: 5px;"></td>
                    <td style="text-align: left; padding: 5px;"><span data-field="VAT"></span></td>
                </tr>
                <tr>
                    <td style="text-align: center; padding: 5px;">3.</td>
                    <td style="padding: 5px;">Tổng giá trị hợp đồng</td>
                    <td style="text-align: right; padding: 5px;"></td>
                    <td style="text-align: left; padding: 5px;"><span data-field="TongGiaTriHopDong"></span></td>
                </tr>
                <tr>
                    <td style="text-align: center; padding: 5px;">4.</td>
                    <td style="padding: 5px;">Giá trị đã thực hiện</td>
                    <td style="text-align: right; padding: 5px;"></td>
                    <td style="text-align: left; padding: 5px;"><span data-field="GiaTriDaThucHien"></span></td>
                </tr>
                <tr>
                    <td style="text-align: center; border-bottom: 1px solid black; padding: 5px;">5.</td>
                    <td style="border-bottom: 1px solid black; padding: 5px;">Giá trị đã tạm ứng</td>
                    <td style="text-align: right; padding: 5px;"></td>
                    <td style="text-align: left; border-bottom: 1px solid black; padding: 5px;"><span
                            data-field="GiaTriDaTamUng"></span>
                    </td>
                </tr>
                <tr>
                    <td style="text-align: center; border-bottom: 1px solid black; padding: 5px;">6.</td>
                    <td style="border-bottom: 1px solid black; padding: 5px;"><strong>Giá trị còn phải thanh
                            toán</strong>
                    </td>
                    <td style="text-align: right; padding: 5px;"></td>
                    <td style="text-align: left; border-bottom: 1px solid black; padding: 5px;">
                        <strong><span data-field="GiaTriConLai"></span></strong>
                    </td>
                </tr>
            </table>
            <div id="amount-in-words"></div>


            <p style="margin: 10px 0; text-align: justify;">
                Bên A sẽ thanh toán số tiền còn lại sau 03 ngày kể từ khi hai bên ký kết Biên bản thanh lý này.
            </p>

            <p style="margin: 10px 0; text-align: justify;">
                Biên bản thanh lý này được lập thành 02 (hai) bản có giá trị pháp lý như nhau, mỗi bên giữ 01 bản.
            </p>
        </div>

        <!-- Signatures -->
        <table style="width: 100%; margin-top: 50px; border-collapse: collapse;">
            <tr>
                <td style="width: 45%; text-align: center;">
                    <p style="font-weight: bold; margin: 10px 0;">ĐẠI DIỆN BÊN A</p>
                </td>
                <td style="width: 10%;"></td>
                <td style="width: 45%; text-align: center;">
                    <p style="font-weight: bold; margin: 10px 0;">ĐẠI DIỆN BÊN B</p>
                </td>
            </tr>
        </table>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.js"></script>
    <script>
        // Biến global để lưu dữ liệu
        let contractData = {};

        function editContent() {
            $('#Conten').summernote({
                height: '100vh',
                width: '100%',
                minWidth: 1200,
                focus: true,
                lang: 'vi-VN',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
                    ['fontname', ['fontname']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ],
                fontNames: ['Times New Roman'],
                fontSizes: ['8', '9', '10', '11', '12', '14', '16', '18', '24', '36'],
                styleTags: ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
                callbacks: {
                    onInit: function () {
                        document.querySelector('.save-button').style.display = 'block';
                        document.querySelector('.edit-button').style.display = 'none';
                        document.querySelector('.export-button').style.display = 'none';
                        document.querySelector('.print-button').style.display = 'none';
                    }
                }
            });
        }

        async function saveContent() {
            try {
                document.querySelector('.loading-overlay').style.display = 'flex';

                const contractId = getContractIdFromUrl();
                if (!contractId) {
                    throw new Error('Không tìm thấy ID thanh lý');
                }

                // Lấy giá trị RAW (chưa format) từ editor
                const variableValues = {};

                // Lấy giá trị từ các span và convert về dạng raw
                document.querySelectorAll('[data-field]').forEach(element => {
                    const fieldName = element.getAttribute('data-field');
                    let value = element.textContent || '';

                    // Convert các giá trị đã format về dạng raw để lưu
                    if (fieldName === 'GiaTriConLai' || fieldName === 'GiaTriHopDongChuaVAT' ||
                        fieldName === 'TongGiaTriHopDong' || fieldName === 'GiaTriDaThucHien' ||
                        fieldName === 'GiaTriDaTamUng') {
                        // Loại bỏ "VND" và dấu phẩy để lấy số thô
                        value = value.replace(/[^\d]/g, '');
                        if (value) {
                            variableValues[fieldName] = parseInt(value);
                        }
                    } else if (fieldName === 'NgayThanhLy' || fieldName === 'NgayThanhLy2' ||
                        fieldName === 'NgayHopDong' || fieldName === 'NgayHopDong2') {
                        // Từ "ngày 26 tháng 04 năm 2025" về "2025-04-26"
                        const match = value.match(/ngày (\d+) tháng (\d+) năm (\d+)/);
                        if (match) {
                            const [, day, month, year] = match;
                            variableValues[fieldName] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        }
                    } else if (fieldName === 'VAT') {
                        // Từ "10%" về 0.1
                        const match = value.match(/(\d+)%/);
                        if (match) {
                            variableValues[fieldName] = parseInt(match[1]) / 100;
                        }
                    } else {
                        variableValues[fieldName] = value;
                    }
                });

                // Lấy số tiền bằng chữ
                const amountInWordsElement = document.querySelector('#amount-in-words');
                if (amountInWordsElement) {
                    const text = amountInWordsElement.textContent;
                    const match = text.match(/\(Bằng chữ: (.*?)\)/);
                    if (match && match[1]) {
                        variableValues.GiaTriConLaiText = match[1];
                    }
                }

                console.log('Dữ liệu sẽ lưu:', variableValues);

                // Lưu JSON string vào cột Html
                const jsonString = JSON.stringify(variableValues);

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Liquidations/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Action": "Edit",
                        "Properties": {
                            "Locale": "en-US",
                            "TimeZone": "Asia/Bangkok"
                        },
                        "Rows": [{
                            "ID_SoThanhLy": contractId,
                            "Html": jsonString
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                $('#Conten').summernote('destroy');

                // Reload dữ liệu để hiển thị
                await fetchContractData();

                document.querySelector('.save-button').style.display = 'none';
                document.querySelector('.edit-button').style.display = 'block';
                document.querySelector('.export-button').style.display = 'block';
                document.querySelector('.print-button').style.display = 'block';
                FuiToast.success('Đã lưu thành công')

            } catch (error) {
                console.error('Lỗi lưu:', error);
                FuiToast.error('Có lỗi xảy ra khi lưu: ' + error.message)
            } finally {
                document.querySelector('.loading-overlay').style.display = 'none';
            }
        }

        const appId = '6bea28d8-7d72-4740-8b55-157e2c6ecd28';
        const accessKey = 'V2-GH0P1-kXYPa-L1yZy-dOZDX-57o7O-a0jGu-iTMmX-Z0yzK';
        const region = 'www';

        // Add this new function for printing
        function printDocument() {
            const printButton = document.querySelector('.print-button');
            const exportButton = document.querySelector('.export-button');
            const editContentButton = document.querySelector('.edit-button');

            // Hide both buttons
            if (printButton) printButton.style.display = 'none';
            if (exportButton) exportButton.style.display = 'none';
            if (editContentButton) editContentButton.style.display = 'none';

            // Print the document
            window.print();

            // Show buttons again after printing
            if (printButton) printButton.style.display = 'block';
            if (exportButton) exportButton.style.display = 'block';
            if (editContentButton) editContentButton.style.display = 'block';
        }

        // Add the export function using template
        async function exportToWord() {
            try {
                // Show loading overlay
                document.querySelector('.loading-overlay').style.display = 'flex';

                // Sử dụng dữ liệu từ biến global và format lại cho Word
                const data = {
                    So_thanhly: contractData.SoThanhLy || '',
                    Ngay_thanhly_text: contractData.NgayThanhLy ? formatVietnameseDate(contractData.NgayThanhLy) : '',
                    So_hopdong_text: contractData.SoHopDong || '',
                    Ngay_hopdong_text: contractData.NgayHopDong ? formatVietnameseDate(contractData.NgayHopDong) : '',
                    ten_kh: contractData.TenKH || '',
                    ten_kh_upper: (contractData.TenKH || '').toUpperCase(),
                    Noidung_hopdong: contractData.NoiDungHopDong || '',
                    nguoi_dai_dien_kh: contractData.NguoiDaiDienKH || '',
                    chuc_vu_kh: contractData.ChucVuKH || '',
                    dia_chi_kh: contractData.DiaChiKH || '',
                    mst_kh: contractData.MST_KH || '',
                    Gia_hopdong_chuaVAT: contractData.GiaTriHopDongChuaVAT ? formatVietnameseCurrency(contractData.GiaTriHopDongChuaVAT) : '',
                    VAT: contractData.VAT ? formatVietnameseVAT(contractData.VAT) : '',
                    Tong_giatri_hopdong: contractData.TongGiaTriHopDong ? formatVietnameseCurrency(contractData.TongGiaTriHopDong) : '',
                    Gia_tri_da_thuchien: contractData.GiaTriDaThucHien ? formatVietnameseCurrency(contractData.GiaTriDaThucHien) : '',
                    Giatrida_tamung_text: contractData.GiaTriDaTamUng ? formatVietnameseCurrency(contractData.GiaTriDaTamUng) : '',
                    Gia_tri_con_lai: contractData.GiaTriConLai ? formatVietnameseCurrency(contractData.GiaTriConLai) : '',
                    Giatri_con_lai_text: contractData.GiaTriConLai ? numberToVietnameseText(contractData.GiaTriConLai) : ''
                };

                // Use a web server path to fetch the template file
                const response = await fetch('https://kiemtoanivc.github.io/KiemtoanIVC/templates/A211Thanhly.docx');
                if (!response.ok) {
                    throw new Error(`Could not fetch template: ${response.statusText}`);
                }

                const templateContent = await response.arrayBuffer();

                // Create PizZip instance from binary data
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                console.log('Data passed to template:', data);

                // Render template with data
                doc.setData(data);
                doc.render();

                // Create and download file
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `thanh-ly-hop-dong-${(contractData.SoThanhLy || 'unknown').replace(/\//g, '-')}.docx`;
                saveAs(blob, fileName);

                // Show success message
                FuiToast.success('Xuất file Word thành công');

            } catch (error) {
                console.error('Error exporting to Word template:', error);
                if (error.properties && error.properties.errors) {
                    console.log('Template Error details:', error.properties.errors);
                }
                FuiToast.error('Có lỗi khi xuất file Word: ' + error.message);
            } finally {
                // Hide loading overlay
                document.querySelector('.loading-overlay').style.display = 'none';
            }
        }

        function formatVietnameseDate(dateString) {
            const date = new Date(dateString);
            return `ngày ${String(date.getDate()).padStart(2, '0')} tháng ${String(date.getMonth() + 1).padStart(2, '0')} năm ${date.getFullYear()}`;
        }

        function formatVietnameseCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('₫', 'VND');
        }

        function formatVietnameseVAT(rate) {
            return (rate * 100) + '%';
        }

        function numberToVietnameseText(number) {
            const UNITS = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];
            const DIGITS = ['không', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];

            function readThreeDigits(number) {
                const hundreds = Math.floor(number / 100);
                const tens = Math.floor((number % 100) / 10);
                const ones = number % 10;

                let result = '';

                if (hundreds > 0) {
                    result += DIGITS[hundreds] + ' trăm ';
                    if (tens === 0 && ones > 0) {
                        result += 'lẻ ';
                    }
                }

                if (tens > 1) {
                    result += DIGITS[tens] + ' mươi ';
                    if (ones === 1) {
                        result += 'mốt ';
                    } else if (ones === 5) {
                        result += 'lăm ';
                    } else if (ones > 0) {
                        result += DIGITS[ones] + ' ';
                    }
                } else if (tens === 1) {
                    result += 'mười ';
                    if (ones === 5) {
                        result += 'lăm ';
                    } else if (ones > 0) {
                        result += DIGITS[ones] + ' ';
                    }
                } else if (ones > 0) {
                    if (hundreds > 0) {
                        if (ones === 5) {
                            result += 'lăm ';
                        } else {
                            result += DIGITS[ones] + ' ';
                        }
                    } else {
                        result += DIGITS[ones] + ' ';
                    }
                }

                return result.trim();
            }

            if (!number) return 'Không đồng';

            // Format the number first
            const formattedNumber = new Intl.NumberFormat('vi-VN', {
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            }).format(number);

            // Remove all non-digit characters
            const numStr = formattedNumber.replace(/\D/g, '');
            const num = parseInt(numStr);

            if (num === 0) return 'Không đồng';

            const groups = [];
            let tempNumber = Math.abs(num);

            // Split into groups of three digits
            while (tempNumber > 0) {
                groups.push(tempNumber % 1000);
                tempNumber = Math.floor(tempNumber / 1000);
            }

            let result = '';
            let hasValue = false;

            // Process each group
            for (let i = groups.length - 1; i >= 0; i--) {
                if (groups[i] !== 0) {
                    const text = readThreeDigits(groups[i]);
                    if (text) {
                        result += text + ' ' + UNITS[i] + ' ';
                        hasValue = true;
                    }
                } else if (i % 3 === 0 && hasValue) { // Add 'tỷ' for zero groups in billions
                    result += UNITS[i] + ' ';
                }
            }

            result = result.trim() + ' đồng';
            return result.charAt(0).toUpperCase() + result.slice(1);
        }

        function getContractIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ID_SoThanhLy');
        }

        async function fetchContractData() {
            try {
                const contractId = getContractIdFromUrl();
                if (!contractId) {
                    throw new Error('Không tìm thấy số thanh lý trong URL');
                }

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Liquidations/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter(Liquidations, ID_SoThanhLy = '${contractId}')`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const contract = data.find(c => c.ID_SoThanhLy === contractId);

                if (!contract) {
                    throw new Error(`Không tìm thấy biên bản thanh lý với số: ${contractId}`);
                }

                let finalData = contract;

                // Kiểm tra có dữ liệu đã sửa trong cột Html không
                if (contract.Html && contract.Html.trim()) {
                    try {
                        // Parse JSON từ cột Html
                        const savedVariables = JSON.parse(contract.Html);

                        // Merge dữ liệu gốc với dữ liệu đã sửa
                        finalData = { ...contract, ...savedVariables };

                        console.log('Sử dụng dữ liệu đã sửa:', savedVariables);
                        console.log('Dữ liệu cuối cùng:', finalData);
                    } catch (e) {
                        console.warn('Không thể parse dữ liệu từ cột Html, sử dụng dữ liệu gốc');
                    }
                }

                // Lưu vào biến global để xuất Word
                contractData = finalData;

                // Điền dữ liệu vào template
                document.querySelectorAll('[data-field]').forEach(element => {
                    const fieldName = element.getAttribute('data-field');

                    if (finalData[fieldName] !== undefined && finalData[fieldName] !== null && finalData[fieldName] !== '') {
                        // Xử lý các trường tiền tệ
                        if (fieldName === 'GiaTriConLai' || fieldName === 'GiaTriHopDongChuaVAT' ||
                            fieldName === 'TongGiaTriHopDong' || fieldName === 'GiaTriDaThucHien' ||
                            fieldName === 'GiaTriDaTamUng') {
                            element.textContent = formatVietnameseCurrency(finalData[fieldName]);

                            // Thêm số tiền bằng chữ cho GiaTriConLai
                            if (fieldName === 'GiaTriConLai') {
                                const amountInWords = numberToVietnameseText(finalData[fieldName]);
                                document.querySelector('#amount-in-words').innerHTML = `<div style="margin-top: 5px; font-style: italic;">(Bằng chữ: ${amountInWords})</div>`;
                            }
                        }
                        // Xử lý các trường ngày tháng
                        else if (fieldName === 'NgayThanhLy' || fieldName === 'NgayThanhLy2' ||
                            fieldName === 'NgayHopDong' || fieldName === 'NgayHopDong2') {
                            element.textContent = formatVietnameseDate(finalData[fieldName]);
                        }
                        // Xử lý trường VAT
                        else if (fieldName === 'VAT') {
                            element.textContent = formatVietnameseVAT(finalData[fieldName]);
                        }
                        // Xử lý các trường tên khách hàng (có thể cần uppercase)
                        else if (fieldName === 'TenKH' || fieldName === 'TenKH2' || fieldName === 'TenKH3') {
                            element.textContent = (finalData['TenKH'] || '').toUpperCase();
                        }
                        // Các trường khác
                        else {
                            element.textContent = finalData[fieldName];
                        }
                    }
                });

            } catch (error) {
                console.error('Failed to fetch data:', error);
                document.body.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                   Lỗi khi tải dữ liệu: ${error.message}
               </div>`;
            }
        }

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };

        window.addEventListener('load', fetchContractData);

    </script>
</body>

</html>