<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hợp đồng kiểm toán A210</title>
  
  <!-- CSS tương tự như trong contract_template.html -->
  
  <!-- Thêm các thư viện cần thiết -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.6/docxtemplater.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.1/pizzip.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://unpkg.com/pizzip/dist/pizzip-utils.js"></script>
</head>
<body>
  <div class="container" id="content">
    <!-- Nội dung hợp đồng sẽ được điền ở đây -->
    <div id="loading">Đang tải dữ liệu hợp đồng...</div>
  </div>
  
  <div class="button-container">
    <button onclick="exportToWord()" id="exportButton" disabled>Xuất Word</button>
    <button onclick="viewWordTemplate()">Xem mẫu Word</button>
  </div>
  
  <script>
    // Biến lưu trữ dữ liệu hợp đồng
    let contractData = {};
    
    // Hàm lấy tham số từ URL
    function getParameterByName(name) {
      const url = window.location.href;
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    
    // Hàm tải dữ liệu hợp đồng từ API
    async function loadContractData() {
      const idHopDong = getParameterByName('ID_HopDong');
      
      if (!idHopDong) {
        document.getElementById('loading').innerHTML = 'Lỗi: Thiếu tham số ID_HopDong';
        return;
      }
      
      try {
        
        const response = await fetch(`https://script.google.com/macros/s/AKfycbx45gO6aX8EJ-3YLRlGwUA2_CGERAdVswZcJyGm892e4w7YsG5RfKY9JP196rRByqbVPA/exec?ID_HopDong=${idHopDong}`);
        const data = await response.json();
        
        if (data.error) {
          document.getElementById('loading').innerHTML = `Lỗi: ${data.error}`;
          return;
        }
        
        // Lưu dữ liệu hợp đồng
        contractData = data;
        
        // Hiển thị dữ liệu hợp đồng
        displayContractData(data);
        
        // Kích hoạt nút xuất Word
        document.getElementById('exportButton').disabled = false;
      } catch (error) {
        console.error('Lỗi khi tải dữ liệu:', error);
        document.getElementById('loading').innerHTML = 'Lỗi khi tải dữ liệu hợp đồng. Vui lòng thử lại sau.';
      }
    }
    
    // Hàm hiển thị dữ liệu hợp đồng
    function displayContractData(data) {
      const contentDiv = document.getElementById('content');
      
      // Xóa thông báo đang tải
      document.getElementById('loading').remove();
      
      // Tạo HTML cho hợp đồng
      contentDiv.innerHTML = `
        <h1>HỢP ĐỒNG KIỂM TOÁN</h1>
        <p style="text-align: center;">Số: ${data.SoHopDong}</p>
        <p style="text-align: center;">Hà Nội, ngày ${data.Ngay} tháng ${data.Thang} năm ${data.Nam}</p>
        
        <p style="text-align: center; font-weight: bold;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</p>
        <p style="text-align: center; font-weight: bold;">Độc lập - Tự do - Hạnh phúc</p>
        <p style="text-align: center;">-----o0o-----</p>
        
        <p><strong>GIỮA:</strong></p>
        <p><strong>BÊN A:</strong> ${data.TenKH}</p>
        <p>Địa chỉ: ${data.DiaChiKH}</p>
        <p>Mã số thuế: ${data.MST_KH}</p>
        <p>Số tài khoản: ${data.SoTK_NganHang} tại ${data.TaiNganHang}</p>
        <p>Đại diện: ${data.NguoiDaiDienKH}</p>
        <p>Chức vụ: ${data.ChucVuKH}</p>
        
        <p><strong>VÀ:</strong></p>
        <p><strong>BÊN B:</strong> CÔNG TY TNHH KIỂM TOÁN XYZ</p>
        <p>Địa chỉ: 123 Đường ABC, Quận XYZ, Hà Nội</p>
        <p>Điện thoại: 024.1234.5678</p>
        <p>Mã số thuế: 0123456789</p>
        <p>Đại diện: Ông Nguyễn Văn A</p>
        <p>Chức vụ: Giám đốc</p>
        
        <!-- Thêm nội dung ĐIỀU 1, ĐIỀU 2, v.v. từ Mau_A210_06042025.html -->
        
        <div class="page-break">
          <p style="text-align: center; font-weight: bold;">ĐIỀU 4: PHÍ DỊCH VỤ VÀ PHƯƠNG THỨC THANH TOÁN</p>
          <p>Tổng phí dịch vụ: ${data.ChiPhiKiemToan} (${data.ChiPhiKiemToanBangChu}).</p>
          <p>Lần 1: Tạm ứng 50% trong vòng 05 ngày làm việc kể từ ngày ký hợp đồng.</p>
          <p>Lần 2: Thanh toán 50% còn lại sau khi bên B phát hành báo cáo kiểm toán.</p>
        </div>
        
        <!-- Thêm các điều khoản khác -->
        
        <div class="signature">
          <div class="signature-block">
            <p><strong>ĐẠI DIỆN BÊN A</strong></p>
            <p>(Ký, đóng dấu, ghi rõ họ tên)</p>
            <br><br><br><br>
            <p>${data.NguoiDaiDienKH}</p>
          </div>
          <div class="signature-block">
            <p><strong>ĐẠI DIỆN BÊN B</strong></p>
            <p>(Ký, đóng dấu, ghi rõ họ tên)</p>
            <br><br><br><br>
            <p>Nguyễn Văn A</p>
          </div>
        </div>
      `;
    }
    
    // Hàm để tải file từ URL
    function loadFile(url, callback) {
      PizZipUtils.getBinaryContent(url, callback);
    }
    
    // Hàm xuất Word sử dụng docxtemplater
    function exportToWord() {
      // Hiển thị trạng thái tải
      const exportButton = document.getElementById('exportButton');
      exportButton.disabled = true;
      exportButton.textContent = 'Đang xuất Word...';
      
      // URL của template trên GitHub
      const templateUrl = 'https://raw.githubusercontent.com/KiemtoanIVC/KiemtoanIVC/main/Mau_A210_Viet.docx';
      
      // Tải template Word
      loadFile(templateUrl, function(error, content) {
        if (error) {
          console.error('Lỗi khi tải template:', error);
          alert('Không thể tải template Word. Vui lòng thử lại sau.');
          exportButton.disabled = false;
          exportButton.textContent = 'Xuất Word';
          return;
        }
        
        // Tạo một instance của PizZip từ template
        const zip = new PizZip(content);
        
        // Tạo một instance của docxtemplater
        const doc = new window.docxtemplater().loadZip(zip);
        
        // Thiết lập dữ liệu để thay thế trong template
        doc.setData(contractData);
        
        try {
          // Render document (thay thế các biến)
          doc.render();
          
          // Tạo output
          const output = doc.getZip().generate({
            type: 'blob',
            mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          });
          
          // Tải file về máy người dùng
          saveAs(output, `Hop_dong_kiem_toan_${contractData.SoHopDong}.docx`);
          
        } catch (error) {
          console.error('Lỗi khi tạo file Word:', error);
          alert('Có lỗi xảy ra khi tạo file Word. Vui lòng thử lại sau.');
        }
        
        // Khôi phục trạng thái nút
        exportButton.disabled = false;
        exportButton.textContent = 'Xuất Word';
      });
    }
    
    // Hàm xem mẫu Word
    function viewWordTemplate() {
      window.open('https://docs.google.com/gview?url=https://raw.githubusercontent.com/KiemtoanIVC/KiemtoanIVC/main/Mau_A210_Viet.docx&embedded=true', '_blank');
    }
    
    // Tải dữ liệu khi trang được tải
    document.addEventListener('DOMContentLoaded', loadContractData);
  </script>
</body>
</html>
